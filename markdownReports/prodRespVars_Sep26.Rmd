---
title: "Response Variables - Resids vs R/S vs recruits"
author: "Cam Freshwater"
date: "September 26, 2018"
output: html_document
---

Below is a messy figure that updates the version I sent last weekend. I added in recruit abundance as an alternative "response" given the issues with weighting component variability in productivity (namely it either doesn't make sense mathematically or it doesn't make sense ecologically). I could also use spawner abundance, but I figure recruits will be less influenced by changes in exploitation rate.

The main point here is that while the retrospective trends (black lines) are consistent regardless of metric, the ability of forward simulations to replicate those trends is variable. In particular simulated recruit abundance (colored dotted lines) is muted relative to the observed (black dotted line) and other metrics (dashed and solid lines). This difference is most striking when looking at retrospective synchrony. Unfortunately I am not sure what would cause synchrony in recruit abundance to appear so elevated or how we could easily adapt the simulation model to produce even higher levels of synchrony in recruit abundance. Any further increases in the strength of correlations in recruitment devations seems unrealistic. 

This shortcoming may be an issue because the justification for using the current synchrony treatment is that: a) they are consistent with moving window estimates of mean pairwise correlations in observed recruitment residuals and b) they produce trends in productivity that are consistent with observed patterns. I guess the question is whether the latter is still a reasonable argument if we use recruit abundance as the main metric in the retrospective analysis. If so we can highlight that the model is *underestimating* future levels of recruitment synchrony relative to recent years, which might suggest our conclusions are conservative. Otherwise I am open to ideas on how best to coerce the model to increase synchrony in this dimension.


```{r, warning=FALSE, message=FALSE, echo = FALSE}
library(plyr)
library(here)
library(dplyr)
library(reshape2)
library(tidyr)
library(ggpubr)
source(here("scripts/func/postProcessing.R"))
```


```{r import and clean data, echo = FALSE}
plotDat <- readRDS(file = here("outputs/cleanedData/fullSynchTS.rda"))
start <- plotDat %>% 
  filter(!sigmaOM == "obs") %>% 
  summarise(min(year))
start <- start[[1]]

axisSize = 15; dotSize = 3.5; lineSize = 0.8; legendSize = 14
```


```{r generate synch plots comparing response variables, echo = FALSE, warning = FALSE}
colPal2 <- c("black", viridis(length(unique(plotDat$synchOM)) - 1, begin = 0, end = 1))
names(colPal2) <- levels(plotDat$synchOM)
dum <- plotDat %>%
  filter(sigmaOM == "medSigma" | sigmaOM == "obs", prodOM == "Reference Productivity") %>%
  select(1:4, medCorrProd, medCorrResid, medCorrRecBY) %>% 
  gather(key = response, value = corrIndex, medCorrProd, medCorrResid, medCorrRecBY) %>%
  mutate(response = as.factor(response)) %>% 
  mutate(response = recode(response, "medCorrProd" = "R/S", "medCorrResid" = "Resids",
                           "medCorrRecBY" = "Recruits", .default = levels(response)))
p <- ggplot(dum, aes(x = year, y = corrIndex, colour = synchOM, 
                       linetype = response)) +
  labs(x = "Year", y = "Mean Correlation", title = NULL) +
  geom_line(size = 1) +
  geom_vline(xintercept = start, color = "black", linetype = 3, size = 1) +
  scale_colour_manual(name = "Operating Model", values = colPal2,
                      labels = c("obs" = "Observed",
                                 "lowSynch" = expression(paste(rho, " = 0.05")),
                                 "medSynch" = expression(paste(rho, " = 0.50")),
                                 "highSynch" = expression(paste(rho, " = 0.75")))) +
  scale_linetype_discrete(name = "Response\nVariable") +
  theme_sleekX(position = "top")

dum2 <- plotDat %>%
  filter(sigmaOM == "medSigma" | sigmaOM == "obs", prodOM == "Reference Productivity") %>%
  select(1:4, medSynchProd, medSynchResid, medSynchRecBY) %>% 
  gather(key = response, value = synchIndex, medSynchProd, medSynchResid, medSynchRecBY) %>%
  mutate(response = as.factor(response)) %>% 
  mutate(response = recode(response, "medSynchProd" = "R/S", "medSynchResid" = "Resids",
                           "medSynchRecBY" = "Recruits", .default = levels(response)))
p2 <- ggplot(dum2, aes(x = year, y = synchIndex, colour = synchOM, 
                       linetype = response)) +
  labs(x = "Year", y = "Synchrony Index", title = NULL) +
  geom_line(size = 1) +
  geom_vline(xintercept = start, color = "black", linetype = 3, size = 1) +
  scale_colour_manual(name = "Operating Model", values = colPal2,
                      labels = c("obs" = "Observed",
                                 "lowSynch" = expression(paste(rho, " = 0.05")),
                                 "medSynch" = expression(paste(rho, " = 0.50")),
                                 "highSynch" = expression(paste(rho, " = 0.75")))) +
  scale_linetype_discrete(name = "Response\nVariable") +
  theme_sleekX(position = "bottom")
```


```{r figure1, echo = FALSE, warning = FALSE, fig.cap = "Figure 1. Trends in different productivity metrics."}
ggarrange(p, p2, nrow = 2, ncol = 1, common.legend = TRUE, legend = "right")
```



```{r generate synch plots with only recruitment, echo = FALSE, warning = FALSE}
colPal2 <- c("black", viridis(length(unique(plotDat$synchOM)) - 1, begin = 0, end = 1))
names(colPal2) <- levels(plotDat$sigmaOM)
dum <- plotDat %>%
  filter(synchOM == "medSynch" | synchOM == "obs", prodOM == "Reference Productivity") %>%
  select(1:4, medCompCVRecBY) %>% 
  gather(key = response, value = cvIndex, medCompCVRecBY) %>%
  mutate(response = as.factor(response)) %>%
  mutate(response = recode(response, "medCompCVRecBY" = "Recruits", 
                           .default = levels(response)))
p <- ggplot(dum, aes(x = year, y = cvIndex, colour = sigmaOM)) +
  labs(x = "Year", y = "Mean Weighted CV", title = NULL) +
  geom_line(size = 1) +
  geom_vline(xintercept = start, color = "black", linetype = 3, size = 1) +
  scale_colour_manual(name = "Operating Model", values = colPal2,
                      labels = c("obs" = "Observed",
                                 "lowSigma" = expression(paste("0.75", sigma)),
                                 "medSigma" = expression(paste(sigma)),
                                 "highSigma" = expression(paste("1.25", sigma)))) +
  # scale_linetype_discrete(name = "Response\nVariable") +
  theme_sleekX(position = "top")

dum2 <- plotDat %>%
  filter(sigmaOM == "medSigma" | sigmaOM == "obs", prodOM == "Reference Productivity") %>%
  select(1:4, medSynchRecBY) %>% 
  gather(key = response, value = synchIndex, medSynchRecBY) %>%
  mutate(response = as.factor(response)) %>% 
  mutate(response = recode(response, "medSynchRecBY" = "Recruits", 
                           .default = levels(response)))
p2 <- ggplot(dum2, aes(x = year, y = synchIndex, colour = synchOM)) +
  labs(x = "Year", y = "Synchrony Index", title = NULL) +
  geom_line(size = 1) +
  geom_vline(xintercept = start, color = "black", linetype = 3, size = 1) +
  scale_colour_manual(name = "Operating Model", values = colPal2,
                      labels = c("obs" = "Observed",
                                 "lowSynch" = expression(paste(rho, " = 0.05")),
                                 "medSynch" = expression(paste(rho, " = 0.50")),
                                 "highSynch" = expression(paste(rho, " = 0.75")))) +
  # scale_linetype_discrete(name = "Response\nVariable") +
  theme_sleekX(position = "bottom")
```


```{r generate quick output figure for C Holt pres, echo = FALSE, warning = FALSE}
png(here("outputs/miscSensitivity/synchMisc/tsForCHoltPres.png"), height = 6, 
    width = 7.5, units = "in", res = 200)
ggarrange(p, p2, nrow = 2, ncol = 1, common.legend = FALSE, legend = "right")
dev.off()
```
