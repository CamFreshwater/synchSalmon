---
title: "simulation number"
author: "Cam Freshwater"
date: "January 31, 2019"
output: html_document
---

Simulation to determine at what point performance metric outputs stabilize. Run using reference scenario 4 different times with up to 3000 simulations then plot running medians.

```{r importData, echo=TRUE, warning=FALSE}
listOfPackages <- c("here", "parallel", "doParallel", "foreach", 
                    "tidyverse", "tictoc", "samSim")
newPackages <- listOfPackages[!(listOfPackages %in% 
                                  installed.packages()[ , "Package"])]
if (length(newPackages)) {
  install.packages(newPackages)
}
lapply(listOfPackages, require, character.only = TRUE)

simParF <- read.csv(here("data", "sox",
                         "fraserOMInputs_referenceTest2.csv"),
                    stringsAsFactors = F)
cuPar <- read.csv(here("data/sox/fraserCUpars.csv"), stringsAsFactors=F)
srDat <- read.csv(here("data/sox/fraserRecDatTrim.csv"), stringsAsFactors=F)
catchDat <- read.csv(here("data/sox/fraserCatchDatTrim.csv"), stringsAsFactors=F)
ricPars <- read.csv(here("data/sox/pooledRickerMCMCPars.csv"), stringsAsFactors=F)
larkPars <- read.csv(here("data/sox/pooledLarkinMCMCPars.csv"), stringsAsFactors=F)
tamFRP <- read.csv(here("data/sox/tamRefPts.csv"), stringsAsFactors=F)

simParTrim <- simParF 
# # %>% 
#   # filter(scenario %in% c("lowSig", "medSig", "highSig"))
scenNames <- unique(simParTrim$scenario)
dirNames <- sapply(scenNames, function(x) paste(x, unique(simParTrim$species),
                                                sep = "_"))
```

```{r runSim, echo=TRUE, warning=FALSE}
## Define simulations to be run
nTrials <- 20

tic()
for(i in seq_along(dirNames)) {
d <- subset(simParTrim, scenario == scenNames[i])
simsToRun <- split(d, seq(nrow(d)))
lapply(simsToRun, function(x) {
  recoverySim(x, cuPar, catchDat=catchDat, srDat=srDat, variableCU=FALSE,
              ricPars, larkPars=larkPars, tamFRP=tamFRP, dirName=dirNames[i],
              nTrials=nTrials, multipleMPs=TRUE)
})
}
toc()

# for (i in seq_along(dirNames)) {
#   dirName <- dirNames[i]
  # d <- subset(simParTrim, scenario == scenNames[i])
  # simsToRun <- split(d, seq(nrow(d)))
  simsToRun <- split(simParTrim, seq(nrow(simParTrim)))
  dirName <- "simNumber"
  Ncores <- detectCores()
  cl <- makeCluster(Ncores - 1) #save one core
  registerDoParallel(cl)
  clusterEvalQ(cl, c(library(samSim)))
  clusterExport(cl, c("simsToRun","cuPar","nTrials","dirName",
                      "catchDat","srDat","ricPars","larkPars",
                      "tamFRP"), envir=environment())
  tic("run in parallel")
  parLapply(cl, simsToRun, function(x) {
    recoverySim(x, cuPar, catchDat=catchDat, srDat=srDat, variableCU=FALSE,
                ricPars, larkPars=larkPars, tamFRP=tamFRP, dirName=dirName,
                nTrials=nTrials, multipleMPs=FALSE)
    })
  stopCluster(cl) #end cluster
  toc()
# }
```


```{r loadCleanAggTS, echo=TRUE}
fullList <- lapply(dirNames, function (h) {
  dum <- genOutputList(h, agg = TRUE, aggTS = TRUE)[[1]]
  simRange <- (dum[["nPrime"]] + 1):dum[["nYears"]]
  y <- dum[["Ag Recruits RY"]][simRange, ]
  x <- dum[["Prop Above Upper BM"]][simRange, ]
  out <- list(y, x)
  names(out) <- c("aggRec", "ppnCU")
  return(out)
})

# Calculate the median for each trial
medPerTrial <- lapply(fullList, function (h) {
  lapply(h, function (i) {
    apply(i, 2, median)
  })
})

# Calculate rolling median across trials starting 1 and going to n
rollMedians <- function(dat, start = 3) {
  n <- length(dat)
  out <- rep(NA, length.out = n)
  for (i in start:n) {
    out[i] <- median(dat[1:i])
  }
  out
}

lapply(medPerTrial, function (h) {
  lapply(h, function (i) {
    rollMedians(i, start = 5)
  })
})
```
