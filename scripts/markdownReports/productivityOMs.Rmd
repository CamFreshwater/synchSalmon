---
title: "Productivity Scenarios"
author: "Cam Freshwater"
date: "October 10, 2018"
output: html_document
---

```{r, warning=FALSE, message=FALSE, echo = FALSE}
library(sn); library(tidyverse); library(here); library(ggpubr); require(synchrony);
library(zoo)
source(here("scripts/func/postProcessing.R"))
```


First examine three distributions that could represent hypothetical changes in recruitment using univariate version of parameterization in synchrony manuscript. Alpha represents skewness parameter (in the sn pacakge 0 is symmetrical, we use log space to be consistent w/ S. Anderson's manuscript) and nu represents the heavy tailed distribution (anything >10 approaches normal).

```{r generate distributions and construct histograms}
n = 1000000
mu = 0
sig = 1
norm <- rst(n, xi = mu, omega = sig, alpha = log(1), nu = Inf)
skewNorm <- rst(n, xi = mu, omega = sig, alpha = log(0.65), nu = Inf)
skewT <- rst(n, xi = mu, omega = sig, alpha = log(0.65), nu = 3)


distDat <- cbind(norm, skewNorm, skewT) %>% 
  as.data.frame() %>% 
  gather(key = dist, value = value) %>% 
  mutate(dist = as.factor(dist))

distDat %>% 
  group_by(dist) %>% 
  summarize(median = median(value), mean = mean(value))

ggplot(distDat, aes(x = dist, y = value)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
  geom_hline(yintercept = 0, linetype = 2, size = 2) + 
  ylim(-5, 5)
```

Looks like I was incorrect. Skewed distributions do shift the median and mean, which makes sense - otherwise the effect wouldn't exist!


Next step is to read in data from a simulation run w/ the three different prod regimes and see what the effects on PMs look like.

```{r retrieve data for PMs plot, echo = FALSE}
simPar <- read.csv(here("data/opModelScenarios/fraserOMInputs_varyCorr.csv"), stringsAsFactors = F)
simParTrim <- subset(simPar, 
                     scenario == "lowSig" | scenario == "medSig" | 
                       scenario == "highSig" | scenario == "lowSigLowA" | 
                       scenario == "medSigLowA" | scenario == "highSigLowA" | 
                       scenario == "lowSigSkew" | scenario == "medSigSkew" | 
                       scenario == "highSigSkew" | scenario == "lowSigSkewT" |
                       scenario == "medSigSkewT" | scenario == "highSigSkewT"
                     )
scenNames <- unique(simParTrim$scenario)
dirNames <- sapply(scenNames, function(x) paste(x, unique(simParTrim$species), sep = "_"))

vars <- c("medRecRY", "ppnCUUpper", "ppnCUExtant",
          "medCatch", "ppnYrsHighCatch", "stabilityCatch")
omNames <- rep(c("ref", "skewN", "skewT", "lowA"), each = 3)
sigNames <- rep(c("low", "med", "high"), length.out = 12)

plotDat = NULL
for(h in seq_along(dirNames)) {
  agList <- genOutputList(dirNames[h], agg = TRUE)
  keyVar <- sapply(agList, function(x) unique(x$keyVar))
  plotOrder <- sapply(agList, function(x) unique(x$plotOrder))
  singleScen = NULL
  for (i in seq_along(vars)) {
    dum <- data.frame(sigma = rep(sigNames[h], length.out = length(agList)),
                      om = rep(omNames[h], length.out = length(agList)),
                      var = rep(vars[i], length.out = length(agList)),
                      synch = as.factor(keyVar),
                      cat = as.factor(plotOrder),
                      avg = sapply(agList, function(x) median(x[,vars[i]])),
                      lowQ = sapply(agList, function(x) qLow(x[,vars[i]])),
                      highQ = sapply(agList, function(x) qHigh(x[,vars[i]])),
                      row.names = NULL
    )
    singleScen <- rbind(singleScen, dum)
  }
  rownames(singleScen) <- c()
  plotDat <- rbind(plotDat, singleScen) #merge multiple scenarios into one dataframe
}
plotDat <- plotDat %>% 
  mutate(cat = recode(cat, "1" = "low", "2" = "med", "3" = "high", .default = levels(cat))
         ,
         om = recode(om, "ref" = "Reference", "lowA" = "Low Alpha", "skewN" = "Skewed Normal",
                       "skewT" = "Skewed T",
                       .default = levels(om))
  ) %>% 
  mutate(om = factor(om, levels(om)[c(1,4,2,3)]))

colPal <- viridis(length(levels(plotDat$sigma)), begin = 0, end = 1)
names(colPal) <- levels(plotDat$sigma)
axisSize = 14; dotSize = 3.5; lineSize = 0.8

consVars <- c("medRecRY", "ppnCUUpper", "ppnCUExtant") 
consYLabs <- c("Recruit\nAbundance", "Prop. CUs Above\nUpper BM", "Prop. CUs\nExtant")
consPlots <- lapply(seq_along(consVars), function(i) {
  temp <- plotDat %>% 
    filter(var == consVars[i])
  q <- ggplot(temp, aes(x = sigma, y = avg, ymin = lowQ, ymax = highQ, 
                        color = cat, shape = sigma)) +
    labs(x = "Component Variance", y = consYLabs[i], color = "Sim.\nParameter\nValue") +
    geom_pointrange(fatten = dotSize, size = lineSize, position = position_dodge(width = 0.5)) +
    scale_x_discrete(labels = c("low" = expression(paste("0.5", sigma)),
                                "med" = expression(paste("1.0", sigma)),
                                "high" = expression(paste("1.5", sigma)))) +
    scale_colour_manual(name = "Synchrony", values = colPal,
                        labels = c("low" = expression(paste(rho, " = 0.05")),
                                   "med" = expression(paste(rho, " = 0.50")),
                                   "high" = expression(paste(rho, " = 0.75")))) +
    scale_shape_manual(name = "Sigma", breaks = c("low", "med", "high"), 
                       values = c(16, 17, 18), guide = FALSE) +
    facet_wrap(~om, scales = "fixed", ncol = 4)
  if (i == 1) {
    q <- q + theme_sleekX(position = "top", legendSize = 1.05)
  } 
  if (i == 2) {
    q <- q + theme_sleekX(position = "mid", legendSize = 1.05)
  }
  if (i == 3) {
    q <- q + theme_sleekX(position = "bottom", legendSize = 1.05)
  }
  return(q)
})
ggarrange(consPlots[[1]], consPlots[[2]], consPlots[[3]], 
          ncol = 1, nrow = 3, common.legend = TRUE, legend = "right", 
          align = "v", heights = c(1.1,1,1.2))
```

Similar effects at low levels of synchrony, but interactions between synchrony and recruitment deviations result in stronger declines in other treatments. Likely due to productivity being more synchronized when individual recruitment deviations are assoicated with one another.


Next look at individual trials to assess how realized productivity vary across OMs. Look at single trial first, using only data from medium synchrony, medium sigma treatments.

```{r plot temporal trends in realized productivity and distribution, echo = FALSE}
arrayNames <- sapply(dirNames[1], function(x) { #matrix of array names to be passed
  list.files(paste(here("outputs/simData"), x, sep="/"), pattern = "\\Arrays.RData$")
})
sigNames <- rep(c("lowSig", "medSig", "highSig"), length.out = 12)
omNames <- rep(c("ref", "skewN", "skewT", "lowA"), each = 3)

prodList <- lapply(seq_along(dirNames), function(h) { 
  #medSynch treatment only
  datList <- readRDS(paste(here("outputs/simData"), dirNames[h], arrayNames[3], sep = "/"))
  prodDat <- datList$recBY %>% 
    melt() %>% 
    rename("yr" = "Var1", "cu" =  "Var2", "trial" = "Var3", "var" = "value") %>% 
    mutate(sig = sigNames[h], om = omNames[h])  
  return(prodDat)
}) 

drawTrials <- sample.int(50, size = 4, replace = FALSE)
prodFull <- do.call(rbind, prodList) %>% 
  filter(sig == "medSig", !yr < 60) %>% #focus on median sig treatment, sim period
  mutate(om = as.factor(om)) %>% 
  mutate(om = factor(om, levels(om)[c(2,1,3,4)]))

plotList <- lapply(seq_along(drawTrials), function(i) { 
  dum <- prodFull %>% 
    #focus on Chilko data only
    filter(trial == drawTrials[i] , cu == 7) 
  q <- ggplot(dum, aes(x = yr, y = var, colour = om)) +
    labs(x = "Year", y = "", title = drawTrials[i]) +
    geom_line(size = 1) +
    scale_colour_discrete(name = "Operating Model") +
    theme_sleekX(position = "bottom") +
    theme(axis.title.y=element_blank()) +
    facet_wrap(~om, nrow = length(unique(omNames)), ncol = 1)
  p <- ggplot(dum, aes(x = om, y = var, fill = om)) +
    geom_boxplot() +
    labs(x = "Op Model", y = "", title = drawTrials[i]) +
    theme_sleekX(position = "bottom") +
    theme(axis.title.y = element_blank(), axis.title.x = element_blank())
  return(list(q, p))
})

prodLine <- ggarrange(plotList[[1]][[1]], plotList[[2]][[1]],
          plotList[[3]][[1]], plotList[[4]][[1]], 
          ncol = 4, nrow = 1, common.legend = TRUE, legend = "right", 
          align = "v", heights = c(1.1,1,1,1.2))
annotate_figure(prodLine, 
                left = text_grob("Productivity", rot = 90))
prodBox <- ggarrange(plotList[[1]][[2]], plotList[[2]][[2]],
          plotList[[3]][[2]], plotList[[4]][[2]], 
          ncol = 2, nrow = 2, common.legend = TRUE, legend = "right", 
          align = "v", heights = c(1,1,1.2,1.2))
annotate_figure(prodBox, 
                left = text_grob("Productivity", rot = 90), 
                bottom = text_grob("Operating Model"))
```

Declines in productivity associated with skewed t are severe, but do not appear unreasonable, at least for individuals trials. However trends in recruitment are more substantial

```{r plot trends in recruitment by brood year, echo = FALSE}
recBYList <- lapply(seq_along(dirNames), function(h) { 
  datList <- readRDS(paste(here("outputs/simData"), dirNames[h], arrayNames[3], sep = "/"))
  prodDat <- datList$recBY %>% 
    melt() %>% 
    rename("yr" = "Var1", "cu" =  "Var2", "trial" = "Var3", "var" = "value") %>% 
    mutate(sig = sigNames[h], om = omNames[h])  
  return(prodDat)
}) 
recBYDat <- do.call(rbind, recBYList) %>% 
  filter(sig == "medSig", !yr < 60) %>% #focus on median sig treatment, sim period
  mutate(om = as.factor(om)) %>% 
  mutate(om = factor(om, levels(om)[c(2,1,3,4)]))

plotRecList <- lapply(seq_along(drawTrials), function(i) { 
  dum <- recBYDat %>% 
    filter(trial == drawTrials[i] , cu == 7) #focus on Chilko data only
  q <- ggplot(dum, aes(x = yr, y = var, colour = om)) +
    labs(x = "Year", y = "", title = drawTrials[i]) +
    geom_line(size = 1) +
    scale_colour_discrete(name = "Operating Model") +
    theme_sleekX(position = "bottom") +
    theme(axis.title.y=element_blank()) +
    facet_wrap(~om, nrow = length(unique(omNames)), ncol = 1)
  p <- ggplot(dum, aes(x = om, y = var, fill = om)) +
    geom_boxplot() +
    labs(x = "Op Model", y = "", title = drawTrials[i]) +
    theme_sleekX(position = "bottom") +
    theme(axis.title.y = element_blank(), axis.title.x = element_blank())
  return(list(q, p))
})

recLine <- ggarrange(plotRecList[[1]][[1]], plotRecList[[2]][[1]],
          plotRecList[[3]][[1]], plotRecList[[4]][[1]], 
          ncol = 4, nrow = 1, common.legend = TRUE, legend = "right", 
          align = "v", heights = c(1.1,1,1,1.2))
annotate_figure(recLine, 
                left = text_grob("Rec BY", rot = 90))
recBox <- ggarrange(plotRecList[[1]][[2]], plotRecList[[2]][[2]],
          plotRecList[[3]][[2]], plotRecList[[4]][[2]], 
          ncol = 2, nrow = 2, common.legend = TRUE, legend = "right", 
          align = "v", heights = c(1,1,1.2,1.2))
annotate_figure(recBox, 
                left = text_grob("Rec BY", rot = 90), 
                bottom = text_grob("Operating Model"))
```

Declines in recruitment are much more severe than average productivity, due to relative declines in strong positive recruitments.

What happens to trends in synchrony across the same trials?

```{r plot synchrony across trials, echo = FALSE}
omNames <- c("ref", "skewN", "skewT", "lowA")
dirNamesTrim <- dirNames[c(2, 5, 8, 11)] # cherry pick only mod sigma trials to speed up calcs
recList <- lapply(seq_along(dirNamesTrim), function(h) { 
  datList <- readRDS(paste(here("outputs/simData"), dirNames[h], arrayNames[3], 
                           sep = "/"))
  recDat <- datList$recBY[ , , drawTrials] #subset to focus only on trials of interest
  synchList1 <- lapply(seq_along(drawTrials), function(i) {
    dum <- recDat[ , , i]
    synchDat <- data.frame(om = omNames[h],
                           trial = drawTrials[i],
                           yr = seq(1, nrow(recDat), by = 1),
                           synch = rollapplyr(dum, width = 12, 
                                         function(x) community.sync(x)$obs, 
                                         fill = NA, by.column = FALSE)
                           )
    return(synchDat)
  })
  synchDat2 <- do.call(rbind, synchList1)
  return(synchDat2)
}) 

synchDatFinal <- do.call(rbind, recList) %>% 
  filter(yr > 59) %>% #drop observation period
  mutate(om = factor(om, levels(om)[c(1,4,2,3)])) 

synchPlotList <- lapply(seq_along(drawTrials), function(j) {
  dum <- synchDatFinal %>% 
    filter(trial == drawTrials[j])
  q <- ggplot(dum, aes(x = yr, y = synch, colour = om)) +
    labs(x = "Year", y = "", title = drawTrials[j]) +
    geom_line(size = 1) +
    scale_colour_discrete(name = "Operating Model") +
    theme_sleekX(position = "bottom") +
    theme(axis.title.y=element_blank()) +
    facet_wrap(~om, nrow = length(unique(omNames)), ncol = 1)
  p <- ggplot(dum, aes(x = om, y = synch, fill = om)) +
    geom_boxplot() +
    labs(x = "Op Model", y = "", title = drawTrials[i]) +
    theme_sleekX(position = "bottom") +
    theme(axis.title.y = element_blank(), axis.title.x = element_blank())
  return(list(q, p))
})

synchLine <- ggarrange(synchPlotList[[1]][[1]], synchPlotList[[2]][[1]],
          synchPlotList[[3]][[1]], synchPlotList[[4]][[1]], 
          ncol = 4, nrow = 1, common.legend = TRUE, legend = "right", 
          align = "v", heights = c(1.1,1,1,1.2))
annotate_figure(synchLine, 
                left = text_grob("Synchrony", rot = 90))
synchBox <- ggarrange(synchPlotList[[1]][[2]], synchPlotList[[2]][[2]],
          synchPlotList[[3]][[2]], synchPlotList[[4]][[2]], 
          ncol = 2, nrow = 2, common.legend = TRUE, legend = "right", 
          align = "v", heights = c(1,1,1.2,1.2))
annotate_figure(synchBox, 
                left = text_grob("Synchrony", rot = 90), 
                bottom = text_grob("Operating Model"))
```

No clear trend driving differences in synchrony patterns among operating models though lowA seems to be reduced in general.

Intuitively it seems clear that changes in productivity via skewed deviations should result in strong declines in abundance because both the mean and average deviations are shared, but unclear why a decrease in the mean + high correlation in deviations does not get you to the same place.